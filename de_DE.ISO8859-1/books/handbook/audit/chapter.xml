<?xml version="1.0" encoding="iso-8859-1"?>
<!--
     The FreeBSD Documentation Project
     The FreeBSD German Documentation Project

     $FreeBSD$
     $FreeBSDde: de-docproj/books/handbook/audit/chapter.xml,v 1.14 2012/02/16 20:28:26 bcr Exp $
     basiert auf: r48529
-->
<!-- Need more documentation on praudit, auditreduce, etc.  Plus more info
on the triggers from the kernel (log rotation, out of space, etc).
And the /dev/audit special file if we choose to support that.  Could use
some coverage of integrating MAC with Event auditing and perhaps discussion
on how some companies or organizations handle auditing and auditing
requirements. -->
<chapter xmlns="http://docbook.org/ns/docbook"
  xmlns:xlink="http://www.w3.org/1999/xlink" version="5.0"
  xml:id="audit">

  <info>
    <title>Security Event Auditing</title>

    <authorgroup>
      <author>
	<personname>
	  <firstname>Tom</firstname>
	  <surname>Rhodes</surname>
	</personname>
	<contrib>Geschrieben von </contrib>
      </author>

      <author>
	<personname>
	  <firstname>Robert</firstname>
	  <surname>Watson</surname>
	</personname>
      </author>
    </authorgroup>

    <authorgroup>
      <author>
	<personname>
	  <firstname>Daniel</firstname>
	  <surname>Seuffert</surname>
	</personname>
	<contrib>Übersetzt von </contrib>
      </author>
    </authorgroup>
  </info>

  <sect1 xml:id="audit-synopsis">
    <title>Einleitung</title>

    <indexterm><primary>AUDIT</primary></indexterm>
    <indexterm>
      <primary>Security Event Auditing</primary>
      <see>MAC</see>
    </indexterm>

    <para>&os; bietet Unterstützung für Sicherheits-Auditing.
      Ereignis-Auditing bietet zuverlässige, feingranulierte und
      konfigurierbare Aufzeichnung einer Vielzahl von
      sicherheitsrelevanten Systemereignissen einschließlich
      Benutzereingaben, Konfigurationsänderungen sowie Datei- und
      Netzwerkzugriffen.  Diese Log-Datensätze können
      unschätzbar wertvoll sein für direkte
      Systemüberwachung, Einbruchserkennung und
      Post-Mortem-Analyse.  &os; implementiert &sun;s öffentlich
      zugängliches Basic Security Module (<acronym>BSM</acronym>)
      Application Programming Interface (<acronym>API</acronym>) und
      Dateiformat, und kann mit den Audit-Implementierungen von
      &sun; &solaris; und &apple; &macos; X zusammenarbeiten.</para>

    <para>Dieses Kapitel konzentriert sich auf die Installation
      und Konfiguration des Ereignis-Auditings.  Es erklärt
      Audit-Richtlinien und stellt ein Beispiel einer
      Audit-Konfiguration vor.</para>

    <para>Nach dem Lesen dieses Kapitels werden Sie
      Folgendes wissen:</para>

    <itemizedlist>
      <listitem>
	<para>Was Ereignis-Auditing ist und wie es
	  funktioniert.</para>
      </listitem>

      <listitem>
	<para>Wie man Ereignis-Auditing in &os; für Benutzer
	  und Prozesse konfiguriert.</para>
      </listitem>

      <listitem>
	<para>Wie man den Audit-Pfad mittels Audit-Reduktion und
	  Revisionswerkzeugen überprüft.</para>
      </listitem>
    </itemizedlist>

    <para>Vor dem Lesen dieses Kapitels sollten Sie:</para>

    <itemizedlist>
      <listitem>
	<para>Sowohl &unix; als auch &os;-Basismechanismen
	  beherrschen (<xref linkend="basics"/>).</para>
      </listitem>

      <listitem>
	<para>Mit den grundlegenden Mechanismen der
	  Kernel-Konfiguration und -Kompilierung vertraut sein (<xref
	    linkend="kernelconfig"/>).</para>
      </listitem>

      <listitem>
	<para>Mit den Maßnahmen zur Sicherung von &os;
	  vertraut sein (<xref linkend="security"/>).</para>
      </listitem>
    </itemizedlist>

    <warning>
      <para>Die Audit-Funktionalität in &os; hat einige bekannte
	Einschränkungen.  Nicht alle sicherheitsrelevanten
	System-Ereignisse sind auditierbar, und einige
	Anmelde-Mechanismen, wie beispielsweise
	<application>Xorg</application>-basierte
	Bildschirm-Manager und Dienste von Drittanbietern,
	konfigurieren das Auditing für Benutzeranmeldungen nicht
	korrekt.</para>

      <para>Das Sicherheits-Auditing ist in der Lage, sehr
	detaillierte Log-Dateien von Systemaktivitäten zu erzeugen.
	Auf einem ausgelasteten System kann die Pfad-Datei sehr groß
	werden, wenn sie für hohe Auflösung konfiguriert ist, und im
	Extremfall pro Woche um mehrere Gigabyte anwachsen.
	Administratoren sollten daher den benötigten Plattenplatz in
	Verbindung mit umfangreichen Audit-Konfigurationen
	berücksichtigen.  So kann es wünschenswert sein, ein eigenes
	Dateisystem für <filename>/var/audit</filename> einzusetzen,
	damit andere Dateisysteme nicht betroffen sind, wenn das
	Dateisystem des Audit voll läuft.</para>
    </warning>
  </sect1>

  <sect1 xml:id="audit-inline-glossary">
    <title>Schlüsselbegriffe</title>

    <para>Die folgenden Begriffe stehen im Zusammenhang mit
      Ereignis-Auditing:</para>

    <itemizedlist>
      <listitem>
	<para><emphasis>event</emphasis>: ein auditierbares Ereignis
	  ist jedes Ereignis, das mit dem Audit-Subsystem
	  aufgezeichnet werden kann.  Beispiele für
	  sicherheitsrelevante Systemereignisse sind etwa das Anlegen
	  von Dateien, das Erstellen einer Netzwerkverbindung oder
	  eine Benutzeranmeldung.  Ereignisse sind entweder
	  <quote>attributierbar</quote>, können also zu einen
	  authentifizierten Benutzer zurückverfolgt werden, oder
	  sind <quote>nicht-attributierbar</quote>.
	  Nicht-attributierbare Ereignisse erfolgen daher vor der
	  Authentifizierung im Anmeldeprozess (beispielsweise die
	  Eingabe eines falschen Passworts).</para>
      </listitem>

      <listitem>
	<para><emphasis>class</emphasis>: benannte Zusammenstellungen
	  von zusammengehörenden Ereignissen, die in
	  Auswahl-Ausdrücken benutzt werden.  Häufig genutzte Klassen
	  von Ereignissen schließen <quote>file creation</quote> (fc,
	  Anlegen von Dateien), <quote>exec</quote> (ex, Ausführung)
	  und <quote>login_logout</quote> (lo, Anmeldung-Abmeldung)
	  ein.</para>
      </listitem>

      <listitem>
	<para><emphasis>record</emphasis>: ein Audit-Logeintrag, der
	  ein Sicherheitsereignis enthält.  Jeder Datensatz enthält
	  einen Ereignistyp, Informationen über den Gegenstand
	  (Benutzer), welcher die Aktion durchführt, Datums- und
	  Zeitinformationen, Informationen über jedes Objekt oder
	  Argument sowie den Zustand hinsichtlich Erfolg oder
	  Scheitern der Operation.</para>
      </listitem>

      <listitem>
	<para><emphasis>trail</emphasis>: eine Log-Datei bestehend aus
	  einer Reihe von Audit-Datensätzen, die Sicherheitsereignisse
	  beschreiben.  Pfade sind in grober zeitlicher Reihenfolge
	  bezüglich des Zeitpunktes, an welchem ein Ereignis beendet
	  wurde.  Nur autorisierte Prozesse dürfen Datensätze zum
	  Audit-Pfad hinzufügen.</para>
      </listitem>

      <listitem>
	<para><emphasis>selection expression</emphasis>: eine
	  Zeichenkette, welche eine Liste von Präfixen und
	  Audit-Ereignisklassennamen enthält, um Ereignisse
	  abzugleichen.</para>
      </listitem>

      <listitem>
	<para><emphasis>preselection</emphasis>: der Prozess, durch
	  den das System erkennt, welche Ereignisse von Interesse für
	  den Administrator sind, um die Erzeugung von Datensätze zu
	  verhindern, welche nicht von Belang sind.  Die Konfiguration
	  der Vorauswahl benutzt eine Reihe von Auswahl-Ausdrücken, um
	  zu erkennen, welche Klassen von Ereignissen für welche
	  Benutzer aufgezeichnet werden sollen sowie globale
	  Einstellungen, welche sowohl auf autorisierte als auch
	  unautorisierte Prozesse angewendet werden.</para>
      </listitem>

      <listitem>
	<para><emphasis>reduction</emphasis>: Die Reduzierung ist der
	  Prozess, durch den Datensätze von bestehenden Audit-Pfaden
	  ausgewählt werden für Speicherung, Ausdruck oder Analyse.
	  Ebenso der Prozess, durch den unerwünschte Datensätze aus
	  dem Audit-Pfad entfernt werden.  Mittels Reduzierung können
	  Administratoren Richtlinien für die Speicherung von
	  Audit-Daten vorgeben.  Zum Beispiel können ausführliche
	  Audit-Pfade für einen Monat gespeichert werden, um danach
	  den Pfad für archivarische Zwecke auf die
	  Anmeldeinformationen zu reduzieren.</para>
      </listitem>
    </itemizedlist>
  </sect1>

  <sect1 xml:id="audit-config">
    <title>Audit Konfiguration</title>

    <para>Userspace-Unterstützung für Ereignis-Auditing ist
      Bestandteil des &os;-Betriebssystems.  Kernel-Unterstützung ist
      in der Voreinstellung im <filename>GENERIC</filename>-Kernel
      enthalten und &man.auditd.8; kann durch Hinzufügen der folgenden
      Zeile in <filename>/etc/rc.conf</filename> aktiviert
      werden:</para>

    <programlisting>auditd_enable="YES"</programlisting>

    <para>Starten Sie anschließend den Audit-Daemon:</para>

    <screen>&prompt.root; <userinput>service auditd start</userinput></screen>

    <para>Benutzer, die es bevorzugen einen angepassten Kernel zu
      kompilieren, müssen folgende Zeile in die
      Kernelkonfigurationsdatei aufnehmen:</para>

    <programlisting>options   AUDIT</programlisting>

    <sect2>
      <title>Ereignis-Auswahlausdrücke</title>

      <para>Auswahlausdrücke werden an einigen Stellen der
	Audit-Konfiguration benützt, um zu bestimmen, welche
	Ereignisse auditiert werden sollen.  Die Ausdrücke enthalten
	eine Liste der Ereignisklassen, welche verglichen werden
	sollen.  Auswahlausdrücke werden von links nach rechts
	ausgewertet und zwei Ausdrücke werden durch Aneinanderhängen
	miteinander kombiniert.</para>

      <para><xref linkend="event-selection"/> fasst die
	Audit-Ereignisklassen zusammen:</para>

      <table xml:id="event-selection" frame="none" pgwide="1">
	<title>Audit-Ereignisklassen</title>

	<tgroup cols="3">
	  <thead>
	    <row>
	      <entry>Name der Klasse</entry>
	      <entry>Beschreibung</entry>
	      <entry>Aktion</entry>
	    </row>
	  </thead>

	  <tbody>
	    <row>
	      <entry>all</entry>
	      <entry>all</entry>
	      <entry>Vergleicht alle Ereigsnisklassen.</entry>
	    </row>

	    <row>
	      <entry>aa</entry>
	      <entry>authentication and authorization</entry>
	      <entry></entry>
	    </row>

	    <row>
	      <entry>ad</entry>
	      <entry>administrative</entry>
	      <entry>Administrative Aktionen, ausgeführt auf dem
		System als Ganzes.</entry>
	    </row>

	    <row>
	      <entry>ap</entry>
	      <entry>application</entry>
	      <entry>Aktionen definiert für Applikationen.</entry>
	    </row>

	    <row>
	      <entry>cl</entry>
	      <entry>file close</entry>
	      <entry>Audit-Aufrufe für den Systemaufruf
		<function>close</function>.</entry>
	    </row>

	    <row>
	      <entry>ex</entry>
	      <entry>exec</entry>
	      <entry>Ausführung des Audit-Programms.  Auditierung von
		Befehlszeilen-Argumenten und Umgebungsvariablen wird
		gesteuert durch &man.audit.control.5; mittels der
		<literal>argv</literal> und
		<literal>envv</literal>-Parameter gemäß der
		<literal>Richtlinien</literal>-Einstellungen.</entry>
	    </row>

	    <row>
	      <entry>fa</entry>
	      <entry>file attribute access</entry>
	      <entry>Auditierung des Zugriffs auf Objektattribute wie
		&man.stat.1; und &man.pathconf.2;.</entry>
	    </row>

	    <row>
	      <entry>fc</entry>
	      <entry>file create</entry>
	      <entry>Audit-Ereignisse, bei denen eine Datei als
		Ergebnis angelegt wird.</entry>
	    </row>

	    <row>
	      <entry>fd</entry>
	      <entry>file delete</entry>
	      <entry>Audit-Ereignisse, bei denen Dateilöschungen
		vorkommen.</entry>
	    </row>

	    <row>
	      <entry>fm</entry>
	      <entry>file attribute modify</entry>
	      <entry>Audit-Ereignisse, bei denen Dateiattribute
		geändert werden, wie &man.chown.8;, &man.chflags.1;
		und &man.flock.2;.</entry>
	    </row>

	    <row>
	      <entry>fr</entry>
	      <entry>file read</entry>
	      <entry>Audit-Ereignisse, bei denen Daten gelesen oder
		Dateien zum lesen geöffnet werden.</entry>
	    </row>

	    <row>
	      <entry>fw</entry>
	      <entry>file write</entry>
	      <entry>Audit-Ereignisse, bei denen Daten geschrieben
		oder Dateien geschrieben oder verändert
		werden.</entry>
	    </row>

	    <row>
	      <entry>io</entry>
	      <entry>ioctl</entry>
	      <entry>Nutzung des Systemaufrufes
		<function>ioctl</function> durch Audit.</entry>
	    </row>

	    <row>
	      <entry>ip</entry>
	      <entry>ipc</entry>
	      <entry>Auditierung verschiedener Formen von
		Inter-Prozess-Kommunikation einschließlich POSIX-Pipes
		und System V
		<acronym>IPC</acronym>-Operationen.</entry>
	    </row>

	    <row>
	      <entry>lo</entry>
	      <entry>login_logout</entry>
	      <entry>Audit-Ereignisse von &man.login.1; und
		&man.logout.1;.</entry>
	    </row>

	    <row>
	      <entry>na</entry>
	      <entry>non attributable</entry>
	      <entry>Auditierung nicht-attributierbarer
		Ereignisse.</entry>
	    </row>

	    <row>
	      <entry>no</entry>
	      <entry>invalid class</entry>
	      <entry>Kein Abgleich von Audit-Ereignissen.</entry>
	    </row>

	    <row>
	      <entry>nt</entry>
	      <entry>network</entry>
	      <entry>Audit-Ereignisse in Zusammenhang mit
		Netzwerkaktivitäten wie &man.connect.2; und
		&man.accept.2;</entry>
	    </row>

	    <row>
	      <entry>ot</entry>
	      <entry>other</entry>
	      <entry>Auditierung verschiedener Ereignisse.</entry>
	    </row>

	    <row>
	      <entry>pc</entry>
	      <entry>process</entry>
	      <entry>Auditierung von Prozess-Operationen wie
		&man.exec.3; und &man.exit.3;.</entry>
	    </row>
	  </tbody>
	</tgroup>
      </table>

      <para>Diese Ereignisklassen können angepasst werden durch
	Modifizierung der Konfigurationsdateien
	<filename>audit_class</filename> und
	<filename>audit_event</filename>.</para>

      <para>Jede Audit-Klasse kann mit einem Präfix kombiniert werden,
	welches anzeigt, ob erfolgreiche/gescheiterte Operationen
	abgebildet werden, und ob der Eintrag den Abgleich hinzufügt
	oder entfernt für die Klasse und den Typ.  <xref
	  linkend="event-prefixes"/> fasst die verfügbaren Präfixe
	zusammen.</para>

      <table xml:id="event-prefixes" frame="none" pgwide="1">
	<title>Präfixe für Audit-Ereignisklassen</title>

	<tgroup cols="2">
	  <thead>
	    <row>
	      <entry>Präfix</entry>
	      <entry>Aktion</entry>
	    </row>
	  </thead>

	  <tbody>
	    <row>
	      <entry>+</entry>
	      <entry>Auditiert erfolgreiche Ereignisse in dieser
		Klasse.</entry>
	    </row>

	    <row>
	      <entry>-</entry>
	      <entry>Auditiert fehlgeschlagene Ereignisse in dieser
		Klasse.</entry>
	    </row>

	    <row>
	      <entry>^</entry>
	      <entry>Auditiert weder erfolgreiche noch fehlgeschlagene
		Ereignisse.</entry>
	    </row>

	    <row>
	      <entry>^+</entry>
	      <entry>Auditiert keine erfolgreichen Ereignisse in
		dieser Klasse.</entry>
	    </row>

	    <row>
	      <entry>^-</entry>
	      <entry>Auditiert keine fehlgeschlagenen Ereignisse in
		dieser Klasse.</entry>
	    </row>
	  </tbody>
	</tgroup>
      </table>

      <para>Wenn kein Präfix vorhanden ist, werden sowohl erfolgreiche
	als auch fehlgeschlagene Ereignisse auditiert.</para>

      <para>Das folgende Beispiel einer Auswahl-Zeichenkette
	wählt erfolgreiche und gescheiterte
	Anmelde/Abmelde-Ereignisse aus, aber nur erfolgreich beendete
	Ausführungs-Ereignisse:</para>

      <programlisting>lo,+ex</programlisting>
    </sect2>

    <sect2>
      <title>Konfigurationsdateien</title>

      <para>Die folgenden Konfigurationsdateien für
	Sicherheits-Auditing befinden sich in
	<filename>/etc/security</filename>.</para>

      <itemizedlist>
	<listitem>
	  <para><filename>audit_class</filename>: enthält die
	    Definitionen der Audit-Klassen.</para>
	</listitem>

	<listitem>
	  <para><filename>audit_control</filename>: steuert die
	    Eigenschaften des Audit-Subsystems, wie
	    Standard-Audit-Klassen, Mindestfestplattenspeicher auf
	    dem Audit-Log-Volume und die maximale Größe des
	    Audit-Trails.</para>
	</listitem>

	<listitem>
	  <para><filename>audit_event</filename>: Namen und
	    Beschreibungen der Audit-Ereignisse, und eine Liste
	    von Klassen mit den dazugehörigen Ereignissen.</para>
	</listitem>

	<listitem>
	  <para><filename>audit_user</filename>: benutzerspezifische
	    Audit-Anforderungen, kombinierbar mit den globalen
	    Standardeinstellungen bei der Anmeldung.</para>
	</listitem>

	<listitem>
	  <para><filename>audit_warn</filename>: ein anpassbares
	    Skript, das von &man.auditd.8; verwendet wird, um in
	    bestimmten Situationen Warnmeldungen zu generieren,
	    z.B. wenn der Platz für Audit-Protokolle knapp wird, oder
	    wenn die Datei des Audit-Trails rotiert wurde.</para>
	</listitem>
      </itemizedlist>

      <warning>
	<para>Konfigurationsdateien von Audit sollten sorgfältig
	  bearbeitet und gepflegt werden, da Fehler in der
	  Konfiguration zu einer fehlerhaften Protokollierung der
	  Ereignisse führen können.</para>
      </warning>

      <para>In den meisten Fällen wird der Administrator nur
	<filename>audit_control</filename> und
	<filename>audit_user</filename> anpassen müssen.  Die erste
	Datei steuert systemweite Audit-Eigenschaften, sowie
	Richtlinien.  Die zweite Datei kann für die Feinabstimmung bei
	der Auditierung von Benutzern verwendet werden.</para>

      <sect3 xml:id="audit-auditcontrol">
        <title>Die <filename>audit_control</filename>-Datei</title>

	<para>Die <filename>audit_control</filename>-Datei legt eine
	  Anzahl Vorgabewerte fest:</para>

	<programlisting>dir:/var/audit
dist:off
flags:lo,aa
minfree:5
naflags:lo,aa
policy:cnt,argv
filesz:2M
expire-after:10M</programlisting>

	<para>Die Option <option>dir</option> wird genutzt, um eines
	  oder mehrere Verzeichnisse festzulegen, in welchen
	  Audit-Protokolle gespeichert werden.  Gibt es mehrere
	  Verzeichniseinträge, werden diese in der angegebenen
	  Reihenfolge genutzt, bis sie jeweils gefüllt sind.  Es ist
	  üblich, Audit so zu konfigurieren, dass die Audit-Logs auf
	  einem dedizierten Dateisystem abgelegt werden, um
	  Wechselwirkungen zwischen dem Audit-Subsystem und anderen
	  Subsystemen zu verhindern, falls das Dateisystem voll
	  läuft.</para>

	<para>Ist die Option <option>dist</option> auf
	  <literal>on</literal> oder <literal>yes</literal> gesetzt,
	  wird ein Link der Dateien des Audit-Trails in
	  <filename>/var/audit/dist</filename> erstellt.</para>

	<para>Das <option>flags</option>-Feld legt die systemweite
	  Standard-Vorauswahl-Maske für attributierbare (direkt einem
	  Benutzer zuordenbare) Ereignisse fest.  Im obigen Beispiel
	  werden alle gescheiterten und erfolgreichen Anmelde- und
	  Abmelde-Ereignisse für alle Benutzer aufgezeichnet.</para>

	<para>Die Option <option>minfree</option> definiert den
	  minimalen Prozentsatz an freiem Plattenplatz für das
	  Dateisystem, in welchem der Audit-Pfad abgespeichert wird.
	  Wenn diese Schwelle überschritten ist, wird ein
	  Warnhinweis erzeugt.</para>

	<para>Die <option>naflags</option>-Option bestimmt diejenigen
	  Audit-Klassen, für die nicht-attributierbare Ereignisse
	  aufgezeichnet werden sollen, wie beispielsweise
	  Anmeldeprozesse, Authentifizierung und Autorisierung.</para>

	<para>Die Option <option>policy</option> legt eine durch
	  Kommata getrennte Liste von policy-Flags fest, welche
	  verschiedene Aspekte des Audit-Verhaltens steuern.  Der Flag
	  <literal>cnt</literal> zeigt an, dass das System trotz eines
	  Audit-Fehlers weiterlaufen soll (dieses Flag wird dringend
	  empfohlen).  Ein anderes, häufig genutztes Flag ist
	  <literal>argv</literal>, welches dazu führt, dass
	  Befehlszeilen-Argumente für den Systemaufruf
	  &man.execve.2; als Teil der Befehlsausführung
	  aufgezeichnet werden.</para>

	<para>Die <option>filesz</option>-Option spezifiziert die
	  maximale Größe der Audit-Datei, bevor sie automatisch
	  beendet und rotiert wird.  Der Wert <literal>0</literal>
	  setzt die automatische Log-Rotation außer Kraft.  Falls die
	  angeforderte Dateigröße unterhalb des Minimums von 512K
	  ist, dann wird die Angabe verworfen und ein Log-Hinweis wird
	  erzeugt.</para>

	<para>Die Option <option>expire-after</option> legt fest, wann
	  die Audit-Dateien verfallen und entfernt werden.</para>
      </sect3>

      <sect3 xml:id="audit-audituser">
	<title>Die Datei <filename>audit_user</filename></title>

	<para>Die <filename>audit_user</filename>-Datei erlaubt es dem
	  Administrator, weitere Audit-Erfordernisse für bestimmte
	  Benutzer festzulegen.  Jede Zeile konfiguriert das Auditing
	  für einen Benutzer über zwei Felder:
	  <literal>alwaysaudit</literal> gibt eine Ansammlung von
	  Ereignissen vor, welche immer für diesen Benutzer
	  aufgezeichnet werden.  <literal>neveraudit</literal> legt
	  Ereignisse fest, die niemals für diesen Benutzer auditiert
	  werden sollen.</para>

	<para>Das folgende Beispiel einer
	  <filename>audit_user</filename>-Datei zeichnet
	  Anmelde/Abmelde-Ereignisse, erfolgreiche
	  Befehlsausführungen für den Benutzer
	  <systemitem class="username">root</systemitem>, Anlegen von
	  Dateien und erfolgreiche Befehlsausführungen für den
	  Benutzer <systemitem class="username">www</systemitem> auf.
	  Falls die voreingestellte <filename>audit_control</filename>
	  benutzt wird, dann ist der Eintrag <literal>lo</literal> für
	  <systemitem class="username">root</systemitem> überflüssig
	  und Anmelde/Abmelde-Ereignisse werden für <systemitem
	    class="username">www</systemitem> ebenfalls
	  aufgezeichnet.</para>

	<programlisting>root:lo,+ex:no
www:fc,+ex:no</programlisting>
      </sect3>
    </sect2>
  </sect1>

  <sect1 xml:id="audit-administration">
    <title>Audit-Trails</title>

    <para>Weil Audit-Trails werden im binären
      <acronym>BSM</acronym>-Format gespeichert werden, gibt es
      verschiedene Werkzeuge, um derartige Dateien zu ändern oder sie
      in Textdateien zu konvertieren.  Der Befehl
      <command>praudit</command> wandelt alle Pfad-Dateien in ein
      einfaches Textformat um.  Der Befehl
      <command>auditreduce</command> kann genutzt werden, um die
      Pfad-Dateien für Analyse, Ausdruck, Archivierung oder andere
      Zwecke zu reduzieren.  Eine Reihe von Auswahl-Parametern werden
      von &man.auditreduce.1; unterstützt, einschließlich
      Ereignistyp, Ereignisklasse, Benutzer, Datum und Uhrzeit des
      Ereignisses und den Dateipfad oder das Objekt, mit dem
      gearbeitet wurde.</para>

    <para>Der folgende Befehl schreibt den gesamten Inhalt einer
      angegebenen Audit-Protokolldatei in eine Textdatei:</para>

    <screen>&prompt.root; <userinput>praudit /var/audit/<replaceable>AUDITFILE</replaceable></userinput></screen>

    <para><replaceable>AUDITFILE</replaceable> ist hier die zu
      schreibende Protokolldatei.</para>

    <para>Audit-Pfade bestehen aus einer Reihe von Datensätzen, die
      wiederum aus Kürzeln (token) gebildet werden, die von
      &man.praudit.1; fortlaufend zeilenweise ausgegeben werden.
      Jedes Kürzel ist von einem bestimmten Typ, z.B. enthält
      <literal>header</literal> einen audit-Datensatz-Header oder
      <literal>path</literal> enthält einen Dateipfad von einer
      Suche.  Hier ein Beispiel eines
      <literal>execve</literal>-Ereignisses:</para>

    <programlisting>header,133,10,execve(2),0,Mon Sep 25 15:58:03 2006, + 384 msec
exec arg,finger,doug
path,/usr/bin/finger
attribute,555,root,wheel,90,24918,104944
subject,robert,root,wheel,root,wheel,38439,38032,42086,128.232.9.100
return,success,0
trailer,133</programlisting>

    <para>Dieser Audit stellt einen erfolgreichen
      <literal>execve</literal>-Aufruf dar, in welchem der Befehl
      <literal>finger doug</literal> ausgeführt wurde.
      <literal>exec arg</literal> enthält die Befehlszeile,
      welche die Shell an den Kernel weiterleitet.  Das Kürzel
      <literal>path</literal> enthält den Pfad zur
      ausführbaren Datei (wie vom Kernel wahrgenommen).  Das
      Kürzel <literal>attribute</literal> beschreibt die
      Binärdatei und enthält den Datei-Modus, der genutzt
      werden kann, um zu bestimmen, ob setuid auf die Applikation
      angewendet wurde.  Das Kürzel <literal>subject</literal>
      speichert die Audit-Benutzer-ID, effektive Benutzer-ID und
      Gruppen-ID, wirkliche Benutzer-ID und Gruppen-ID, Prozess-ID,
      Session- ID, Port-ID und Anmelde-Adresse.  Beachten Sie, dass
      Audit-Benutzer-ID und wirkliche Benutzer-ID abweichen, da der
      Benutzer <systemitem class="username">robert</systemitem> zum
      Benutzer <systemitem class="username">root</systemitem> wurde,
      bevor er diesen Befehl ausführte, aber er wird auditiert mit
      dem ursprünglich authentifizierten Benutzer.  Das Kürzel
      <literal>return</literal> zeigt die erfolgreiche Ausführung an
      und <literal>trailer</literal> schließt den Datensatz ab.</para>

    <para>Die Ausgabe im <acronym>XML</acronym>-Format wird ebenfalls
      unterstützt und kann über die Option <option>-x</option>
      ausgewählt werden.</para>

    <para>Da Audit-Protokolldateien sehr groß sein können, kann mit
      Hilfe von <command>auditreduce</command> auch nur eine
      Teilmenge der Datensätze ausgewählt werden.  Dieses Beispiel
      selektiert alle Datensätze des Benutzers <systemitem
	class="username">trhodes</systemitem> aus der Datei
      <filename>AUDITFILE</filename>:</para>

    <screen>&prompt.root; <userinput>auditreduce -u <replaceable>trhodes</replaceable> /var/audit/<replaceable>AUDITFILE</replaceable> | praudit</userinput></screen>

    <para>Mitglieder der Gruppe <systemitem
	class="groupname">audit</systemitem> sind berechtigt,
      Audit-Pfade in <filename>/var/audit</filename> zu lesen.  In
      der Voreinstellung ist diese Gruppe leer, daher kann nur der
      Benutzer <systemitem class="username">root</systemitem> die
      Audit-Pfade lesen.  Benutzer können der Gruppe <systemitem
	class="groupname">audit</systemitem> hinzugefügt werden, um
      Rechte für Audit-Reviews zu gewähren.  Da die Fähigkeit,
      Inhalte von Audit-Protokolldateien zu verfolgen, tiefgreifende
      Einblicke in das Verhalten von Benutzern und Prozessen
      erlaubt, wird empfohlen, dass die Gewährung von Rechten für
      Audit-Reviews mit Bedacht erfolgt.</para>

    <sect2>
      <title>Aktive Überwachung mittels Audit-Pipes</title>

      <para>Audit-Pipes sind nachgebildete (geklonte) Pseudo-Geräte,
	welche es Applikationen erlauben, die laufenden
	Audit-Datensätze anzuzapfen.  Dies ist vorrangig für Autoren
	von Intrusion Detection Software und
	Systemüberwachungsprogrammen von Bedeutung.  Allerdings ist
	das Audit-Pipe-Gerät ein angenehmer Weg für den Administrator,
	aktive Überwachung zu gestatten, ohne Gefahr von Problemen
	durch Besitzerrechte der Audit-Pfad-Datei oder Unterbrechung
	des Stroms von Ereignissen durch Log-Rotation.  Um den
	laufenden Audit-Ereignisstrom zu verfolgen, geben Sie
	folgendes ein:</para>

      <screen>&prompt.root; <userinput>praudit /dev/auditpipe</userinput></screen>

      <para>In der Voreinstellung kann nur der Benutzer
	<systemitem class="username">root</systemitem> auf die
	Audit-Pipe-Geräte-Knotenpunkte zugreifen.  Um sie allen
	Mitgliedern der Gruppe <systemitem
	  class="groupname">audit</systemitem> zugänglich zu machen,
	fügen Sie eine <literal>devfs</literal>-Regel in
	<filename>/etc/devfs.rules</filename> hinzu:</para>

      <programlisting>add path 'auditpipe*' mode 0440 group audit</programlisting>

      <para>Lesen Sie  &man.devfs.rules.5; für weitere Informationen,
	wie das devfs-Dateisystem konfiguriert wird.</para>

      <warning>
	<para>Es ist sehr leicht, Rückmeldungszyklen von
	  Audit-Ereignissen hervorzurufen, in welcher das Betrachten
	  des Resultates eines Audit-Ereignisses in die Erzeugung von
	  mehr Audit-Ereignissen mündet.  Wenn zum Beispiel der
	  gesamte Netzwerk-<acronym>I/O</acronym> auditiert wird,
	  während <command>praudit</command> in einer
	  <acronym>SSH</acronym>-Sitzung gestartet wurde, dann wird
	  ein kontinuierlicher, mächtiger Strom von Audit-Ereignissen
	  erzeugt, da jedes ausgegebene Ereignis wiederum neue
	  Ereignisse erzeugt.  Daher ist anzuraten,
	  <command>praudit</command> an einem Audit-Pipe-Gerät nur
	  von Sitzungen anzuwenden (ohne feingranuliertes
	  <acronym>I/O</acronym>-Auditing), um dies zu
	  vermeiden.</para>
      </warning>
    </sect2>

    <sect2>
      <title>Rotation und Komprimierung von Audit-Pfad-Dateien</title>

      <para>Audit-Pfade werden vom Kernel geschrieben und vom
	Audit-Daemon &man.auditd.8; verwaltet.  Administratoren
	sollten nicht versuchen, &man.newsyslog.conf.5; oder andere
	Werkzeuge zu benutzen, um Audit-Protokolldateien direkt zu
	rotieren.  Stattdessen sollte <command>audit</command> benutzt
	werden, um die Auditierung zu beenden, das Audit-System neu zu
	konfigurieren und eine Log-Rotation durchzuführen.  Der
	folgende Befehl veranlasst den Audit-Daemon, eine neue
	Protokolldatei anzulegen und dem Kernel zu signalisieren, die
	neue Datei zu nutzen.  Die alte Datei wird beendet und
	umbenannt.  Ab diesem Zeitpunkt kann sie vom Administrator
	bearbeitet werden:</para>

      <screen>&prompt.root; <userinput>audit -n</userinput></screen>

      <para>Falls der &man.auditd.8;-Daemon gegenwärtig nicht läuft,
	wird dieser Befehl scheitern und eine Fehlermeldung wird
	ausgegeben.</para>

      <para>Durch das Hinzufügen der folgenden Zeile in
	<filename>/etc/crontab</filename> wird die Log-Rotation alle
	zwölf Stunden durchgeführt:</para>

      <programlisting>0     */12       *       *       *       root    /usr/sbin/audit -n</programlisting>

      <para>Die Änderung wird wirksam, sobald
	<filename>/etc/crontab</filename> gespeichert wird.</para>

      <para>Die automatische Rotation der Audit-Pfad-Datei in
	Abhängigkeit von der Dateigröße ist möglich durch die Angabe
	der Option <option>filesz</option> in
	<filename>audit_control</filename>.  Dieser Vorgang ist in
	<xref linkend="audit-auditcontrol"/> beschrieben.</para>

      <para>Da Audit-Pfad-Dateien sehr groß werden können,
	ist es oft wünschenswert, Pfade zu komprimieren oder
	anderweitig zu archivieren, sobald sie vom Audit-Daemon
	geschlossen wurden.  Das Skript
	<filename>audit_warn</filename> kann genutzt werden, um
	angepasste Aktionen für eine Vielzahl von audit-bezogenen
	Ereignissen auszuführen, einschließlich der sauberen
	Beendigung von Audit-Pfaden, wenn diese geschlossen werden.
	Zum Beispiel kann man die folgenden Zeilen in
	<filename>/etc/security/audit_warn</filename> aufnehmen, um
	Audit-Pfade beim Beenden zu komprimieren:</para>

      <programlisting>#
# Compress audit trail files on close.
#
if [ "$1" = closefile ]; then
        gzip -9 $2
fi</programlisting>

      <para>Andere Archivierungsaktivitäten können das Kopieren zu
	einem zentralen Server, die Löschung der alten Pfad-Dateien
	oder die Reduzierung des alten Audit-Pfades durch Entfernung
	nicht benötigter Datensätze einschließen.  Dieses Skript wird
	nur dann ausgeführt, wenn die Audit-Pfad-Dateien sauber
	beendet wurden, daher wird es nicht auf Pfaden laufen, welche
	durch ein unsauberes Herunterfahren des Systems nicht beendet
	wurden.</para>
    </sect2>
  </sect1>
</chapter>
