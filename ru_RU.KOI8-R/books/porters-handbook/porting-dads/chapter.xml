<?xml version="1.0" encoding="koi8-r"?>
<!--
     The FreeBSD Russian Documentation Project

     $FreeBSD$

     Original revision: r43840
-->

<chapter xmlns="http://docbook.org/ns/docbook"
  xmlns:xlink="http://www.w3.org/1999/xlink" version="5.0"
  xml:id="porting-dads">

  <title>Что делать нужно, и что делать нельзя</title>

  <sect1 xml:id="dads-intro">
    <title>Введение</title>

    <para>Вот список часто встречающихся действий, которые нужно и
      которые нельзя делать во время процесса портирования.
      Проверьте порт по этому списку, и также проверьте порты в <link
	xlink:href="http://www.FreeBSD.org/cgi/query-pr-summary.cgi?query">базе
	сообщений PR</link>, которые присланы другими людьми.
      Присылайте любые комментарии о портах, которые вы проверили,
      так, как это описано в статье о <link
	xlink:href="&url.articles.contributing;/contrib-how.html#CONTRIB-GENERAL">
	Сообщениях об ошибках и общих замечаниях</link>.  Проверка
      портов в базе сообщений PR позволит нам быстрее коммиттить их и
      удостовериться, что вы знаете, что делаете.</para>
  </sect1>

  <sect1 xml:id="porting-wrkdir">
    <title><varname>WRKDIR</varname></title>

    <para>Не пишите ничего в файлы вне каталога
      <varname>WRKDIR</varname>.  Каталог <varname>WRKDIR</varname>
      является единственным местом, которое гарантированно будет
      доступно для записи во время построения порта (обратитесь к
      главе об <link
	xlink:href="&url.books.handbook;/ports-using.html#PORTS-CD">установке
	портов с CDROM</link> за примером построения портов из
      дерева, доступного только для чтения).  Если вам нужно изменить
      какой-либо из файлов <filename>pkg-*</filename>, сделайте это,
      <link linkend="porting-pkgfiles">переопределив
	переменную</link>, но не перезаписывая их.</para>
  </sect1>

  <sect1 xml:id="porting-wrkdirprefix">
    <title><varname>WRKDIRPREFIX</varname></title>

    <para>Добейтесь того, чтобы ваш порт принимал во внимание
      значение переменной <varname>WRKDIRPREFIX</varname>.
      Большинство портов об этом не заботятся.  В частности, если вы
      обращаетесь к каталогу <varname>WRKDIR</varname> другого порта,
      заметьте, что его правильным местоположением является
      <filename>WRKDIRPREFIXPORTSDIR/subdir/name/work</filename>, а
      не <filename>PORTSDIR/subdir/work</filename> или
      <filename>.CURDIR/../../subdir/name/work</filename> мли что-то
      подобное.</para>

    <para>Кроме того, если вы сами задаете <varname>WRKDIR</varname>,
      то должны поставить перед ним знак
      <literal>&dollar;{WRKDIRPREFIX}&dollar;{.CURDIR}</literal>.</para>
  </sect1>

  <sect1 xml:id="porting-versions">
    <title>Различение операционных систем и версий ОС</title>

    <para>Вы можете встретиться с кодом, который требует модификаций
      или условной компиляции в зависимости от того, с какой версией
      &os; Unix он работает.  Предпочтительным способом отделения
      кода для версий &os; является использование макросов
      <literal>__FreeBSD_version</literal> и
      <literal>__FreeBSD__</literal>, определённых в <link
	xlink:href="http://svnweb.freebsd.org/base/head/sys/sys/param.h?view=markup">sys/param.h</link>.
      Если этот файл не подключен, добавьте код</para>

    <programlisting>#include &lt;sys/param.h&gt;</programlisting>

    <para>в нужном месте файла <filename>.c</filename>.</para>

    <para><literal>__FreeBSD__</literal> определён во всех версиях
      &os; в качестве старшего номера версии системы.  Например, в
      &os; 9.x <literal>__FreeBSD__</literal> определён со значением
      <literal>9</literal>.</para>

    <programlisting>#if __FreeBSD__ &gt;= 9
#  if __FreeBSD_version &gt;= 901000
	 /* здесь особый код для версий 9.1+ */
#  endif
#endif</programlisting>
  </sect1>

  <sect1 xml:id="dads-after-port-mk">
    <title>Написание чего-либо после
      <filename>bsd.port.mk</filename></title>

    <para>Не пишите ничего после строки
      <literal>.include &lt;bsd.port.mk&gt;</literal>.  Этой строки
      можно избежать, включив в где-то в середину вашего файла
      <filename>Makefile</filename> файл
      <filename>bsd.port.pre.mk</filename>, и файл
      <filename>bsd.port.post.mk</filename> в конец.</para>

    <note>
      <para>Вам нужно включить либо пару файлов
	<filename>bsd.port.pre.mk</filename>/<filename>bsd.port.post.mk</filename>,
	либо только <filename>bsd.port.mk</filename>; не используйте
	оба этих метода одновременно.</para>
    </note>

    <para>В файле <filename>bsd.port.pre.mk</filename> определяются
      лишь несколько переменных, которые могут быть использованы в
      тестах из файла <filename>Makefile</filename>, в файле
      <filename>bsd.port.post.mk</filename> заданы остальные.</para>

    <para>Вот некоторые важные переменные, определенные в файле
      <filename>bsd.port.pre.mk</filename> (это не полный список, для
      выяснения полного списка прочтите, пожалуйста, сам файл
      <filename>bsd.port.mk</filename>).</para>

    <informaltable frame="none" pgwide="0">
      <tgroup cols="2">
	<thead>
	  <row>
	    <entry>Переменная</entry>
	    <entry>Описание</entry>
	  </row>
	</thead>

	<tbody>
	  <row>
	    <entry><varname>ARCH</varname></entry>
	    <entry>Архитектура машины в виде, получаемом по команде
	      <command>uname -m</command> (например,
	      <literal>i386</literal>)</entry>
	  </row>

	  <row>
	    <entry><varname>OPSYS</varname></entry>
	    <entry>Тип операционной системы, получаемый по команде
	      <command>uname -s</command> (например,
	      <literal>FreeBSD</literal>)</entry>
	  </row>

	  <row>
	    <entry><varname>OSREL</varname></entry>
	    <entry>Версия релиза операционной системы (например,
	      <literal>2.1.5</literal> или
	      <literal>2.2.7</literal>)</entry>
	  </row>

	  <row>
	    <entry><varname>OSVERSION</varname></entry>
	    <entry>Версия операционной системы в виде числа, та же,
	      что и <link linkend="freebsd-versions">
		<literal>__FreeBSD_version</literal></link>.</entry>
	  </row>

	  <row>
	    <entry><varname>LOCALBASE</varname></entry>
	    <entry>Корень дерева <quote>local</quote> (например,
	      <literal>/usr/local</literal>)</entry>
	  </row>

	  <row>
	    <entry><varname>PREFIX</varname></entry>
	    <entry>Куда, собственно, устанавливается порт (обратитесь
	      к <link linkend="porting-prefix">подробной информации о
		<varname>PREFIX</varname></link>).</entry>
	  </row>
	</tbody>
      </tgroup>
    </informaltable>

    <note>
      <para>Если вы задаете переменную <varname>MASTERDIR</varname>,
	делайте это до подключения
	<filename>bsd.port.pre.mk</filename>.</para>
    </note>

    <para>Вот несколько примеров того, что вы можете написать после
      <filename>bsd.port.pre.mk</filename>:</para>

    <programlisting># no need to compile lang/perl5 if perl5 is already in system
.if ${OSVERSION} &gt; 300003
BROKEN=	perl is in system
.endif</programlisting>

    <para>Вы не забываете об использовании табуляции вместо пробелов
      после <literal>BROKEN=</literal><!-- улыбка -->:-).</para>
  </sect1>

  <sect1 xml:id="dads-sh-exec">
    <title>Использование выражения <function>exec</function>
      в сценариях обёртках</title>

    <para>Если порт устанавливает сценарий на языке shell, который
      служит для запуска другой программы, и если запуск этой
      программы является последним действием сценария, убедитесь, что
      запуск программы производится с использованием выражения
      <function>exec</function>, например:</para>

    <programlisting>#!/bin/sh
exec %%LOCALBASE%%/bin/java -jar %%DATADIR%%/foo.jar "$@"</programlisting>

    <para>Выражение <function>exec</function> заменяет процесс
      сценария на указанную программу.  Если
      <function>exec</function> опущен, то процесс сценария во время
      работы программы остается в памяти, бесполезно потребляя
      системные ресурсы.</para>
  </sect1>

  <sect1 xml:id="dads-rational">
    <title>Поступайте разумно</title>

    <para>Файл <filename>Makefile</filename> должен выполнять
      действия просто и небеспричинно.  Если вы можете сделать что-то
      на несколько строк короче или более читабельно, сделайте это.
      В качестве примеров можно привести использование конструкций
      <literal>.if</literal> утилиты make вместо соответствующей
      конструкции <literal>if</literal> командного процессора,
      ненужность переопределения цели
      <buildtarget>do-extract</buildtarget> при возможности
      переопределения <varname>EXTRACT*</varname> и использование
      <varname>GNU_CONFIGURE</varname> вместо
      <literal>CONFIGURE_ARGS
	+= --prefix=&dollar;{PREFIX}</literal>.</para>

    <para>Если вы обнаружите, что для выполнения чего-то приходится
      писать много нового кода, то, пожалуйста, просмотрите файл
      <filename>bsd.port.mk</filename> на предмет того, не содержит
      ли он решение именно вашей проблемы.  Хотя его трудно читать,
      имеется много проблем, выглядящих сложными, для которых файл
      <filename>bsd.port.mk</filename> уже содержит быстрое
      решение.</para>
  </sect1>

  <sect1 xml:id="dads-cc">
    <title>Работа как с <varname>CC</varname>, так и
      <varname>CXX</varname></title>

    <para>Порт должен принимать во внимание как переменную
      <varname>CC</varname>, так и <varname>CXX</varname>.  Под этим
      мы подразумеваем, что порт ни в коем случае не должен
      устанавливать значения этих переменных, переопределяя имеющиеся
      значения; вместо этого можно добавлять нужные значения к уже
      имеющимся.  Это связано с тем, что параметры построения,
      относящиеся ко всем портам, могут быть заданы глобально.</para>

    <para>Если порты не учитывают значения этих переменных, добавьте
      строку <literal>NO_PACKAGE=ignores either cc or cxx</literal>
      в файл <filename>Makefile</filename>.</para>

    <para>Далее следует пример файла <filename>Makefile</filename>,
      использующего как переменную <varname>CC</varname>, так и
      <varname>CXX</varname>.  Обратите внимание на использование
      символов <varname>?=</varname>:</para>

    <programlisting>CC?= gcc</programlisting>

    <programlisting>CXX?= g++</programlisting>

    <para>Вот пример, в котором не принимаются во внимание ни
      <varname>CC</varname>, ни <varname>CXX</varname>:</para>

    <programlisting>CC= gcc</programlisting>

    <programlisting>CXX= g++</programlisting>

    <para>В системах &os; обе переменные <varname>CC</varname> и
      <varname>CXX</varname> могут быть определены в файле
      <filename>/etc/make.conf</filename>.  В первом примере задаётся
      значение, если оно ранее не было определено в
      <filename>/etc/make.conf</filename>, что сохраняет любые
      определения, данные на уровне системы в целом.  Второй пример
      переопределяет всё, что было задано ранее.</para>
  </sect1>

  <sect1 xml:id="dads-cflags">
    <title>Использование <varname>CFLAGS</varname></title>

    <para>Порт должен учитывать переменную <varname>CFLAGS</varname>.
      Под этим мы подразумеваем, что порт ни в коем случае не должен
      устанавливать значения этой переменной, переопределяя имеющиеся
      значения; вместо этого можно добавлять нужные значения к уже
      имеющимся.  Это связано с тем, что параметры построения,
      относящиеся ко всем портам, могут быть заданы глобально.</para>

    <para>Если порты не учитывают значения этой переменной, добавьте
      строку <literal>NO_PACKAGE=ignores cflags</literal> в файл
      <filename>Makefile</filename>.</para>

    <para>Далее следует пример файла <filename>Makefile</filename>,
      использующего переменную <varname>CFLAGS</varname>.  Обратите
      внимание на использование символов <varname>+=</varname>:</para>

    <programlisting>CFLAGS+= -Wall -Werror</programlisting>

    <para>А вот пример, в котором не учитывается значение переменной
      <varname>CFLAGS</varname>:</para>

    <programlisting>CFLAGS= -Wall -Werror</programlisting>

    <para>В системе &os; переменная <varname>CFLAGS</varname>
      определена в файле <filename>/etc/make.conf</filename>.  В
      первом примере к переменной <varname>CFLAGS</varname>
      добавляются дополнительные флаги, при этом сохраняются все
      определения, данные ранее на уровне системы.  Во втором примере
      всё, что было задано ранее, игнорируется.</para>

    <para>Из сторонних файлов <filename>Makefile</filename> следует
      удалить флаги оптимизации.  Общесистемные флаги оптимизации
      находятся в системной переменной <varname>CFLAGS</varname>.
      Пример из немодифицированного
      <filename>Makefile</filename>:</para>

    <programlisting>CFLAGS= -O3 -funroll-loops -DHAVE_SOUND</programlisting>

    <para>При использовании системных флагов оптимизации
      <filename>Makefile</filename> станет похожим на следующий
      пример:</para>

    <programlisting>CFLAGS+= -DHAVE_SOUND</programlisting>
  </sect1>

  <sect1 xml:id="dads-pthread">
    <title>Библиотеки потоков</title>

    <para>Во &os; библиотека потоков обязана быть скомпонована с
      исполняемыми файлами с использованием специального флага
      <literal>-pthread</literal>.  Если порт настаивает на прямой
      компоновке с <literal>-lpthread</literal>, создайте патч для
      использования <literal>-pthread</literal>.</para>

    <note>
      <para>Если построение порта заканчивается ошибкой
	<literal>unrecognized option '-pthread'</literal>, то может
	быть желательно использование <command>cc</command> в
	качестве компоновщика через установку
	<varname>CONFIGURE_ENV</varname> в
	<literal>LD=${CC}</literal>.  Параметр
	<literal>-pthread</literal> напрямую командой
	<command>ld</command> не поддерживается.</para>
    </note>
  </sect1>

  <sect1 xml:id="dads-feedback">
    <title>Пожелания</title>

    <para>Посылайте подходящие изменения/патчи автору/сопровождающему
      для включения в следующий релиз.  Это только сделает вашу
      работу гораздо легче при выходе следующего релиза.</para>
  </sect1>

  <sect1 xml:id="dads-readme">
    <title><filename>README.html</filename></title>

    <para><filename>README.html</filename> не является частью порта
      и генерируется при помощи <command>make readme</command>.
      Не включайте этот файл в патчи или коммиты.</para>

    <note>
      <para>Если не удается выполнить <command>make readme</command>,
	убедитесь, что значение по умолчанию
	<varname>ECHO_MSG</varname> не изменено внутри порта.</para>
    </note>
  </sect1>

  <sect1 xml:id="dads-noinstall">
    <title>Пометка неустанавливаемого порта как
      <varname>BROKEN</varname>, <varname>FORBIDDEN</varname> или
      <varname>IGNORE</varname></title>

    <para>В некоторых случаях пользователи не должны допускаться к
      установке порта.  Для того, чтобы сообщить пользователю, что
      порт не следует устанавливать, имеется несколько
      <command>make</command>-переменных, которые могут быть
      использованы в файле <filename>Makefile</filename> порта.
      Значения следующих <command>make</command>-переменных будут
      причиной, возвращаемой пользователям, по которой порт
      отказывает в установке.  Пожалуйста, используйте корректные
      <command>make</command>-переменные, так как каждая переменная
      make передает абсолютно различный смысл как для пользователей,
      так и для автоматизированных систем, которые полагаются на
      файлы <filename>Makefile</filename>, таких как <link
	linkend="build-cluster">кластер построения портов</link>,
      <link linkend="freshports">FreshPorts</link> и <link
	linkend="portsmon">portsmon</link>.</para>

    <sect2 xml:id="dads-noinstall-variables">
      <title>Переменные</title>

      <itemizedlist>
	<listitem>
	  <para><varname>BROKEN</varname> предназначена для портов,
	    которые в настоящее время не компилируются, не
	    устанавливаются или не удаляются правильно.  Следует
	    использовать, когда проблема считается временной.</para>

	  <para>В особых случаях кластер построения будет продолжать
	    попытки собрать их, чтобы показать, решена ли основная
	    проблема.  (Однако, как правило, кластер запускается без
	    этой возможности.)</para>

	  <para>В частности, используйте <varname>BROKEN</varname>,
	    когда порт:</para>

	  <itemizedlist>
	    <listitem>
	      <para>не компилируется</para>
	    </listitem>

	    <listitem>
	      <para>не выполняет процесс своей конфигурации или
		установки</para>
	    </listitem>

	    <listitem>
	      <para>устанавливает файлы вовне
		<filename>${LOCALBASE}</filename></para>
	    </listitem>

	    <listitem>
	      <para>не удаляет полностью все свои файлы при
		деинсталляции (тем не менее, это может быть
		допустимо, и подходит для портов, оставляющих после
		себя файлы, измененные пользователем)</para>
	    </listitem>
	  </itemizedlist>
	</listitem>

	<listitem>
	  <para><varname>FORBIDDEN</varname> используется для портов,
	    которые содержат уязвимости в информационной безопасности
	    или являются потенциально вредными в плане обеспечения
	    информационной безопасности системы &os; при установке
	    данного порта (например: заведомо небезопасная программа
	    или программа, которая предоставляет легко взламываемые
	    сервисы).  Порты должны помечаться как
	    <varname>FORBIDDEN</varname>, как только в конкретном
	    программном обеспечении обнаружилась уязвимость, но
	    обновление выпущено не было.  В идеальном случае порты
	    должны обновляться максимально быстро после обнаружения
	    уязвимости, чтобы уменьшить число уязвимых хостов &os;
	    (нам нравится иметь репутацию безопасной системы), однако
	    иногда случается значительный временной разрыв между
	    обнаружением уязвимости и выходом обновлённого релиза
	    уязвимого программного обеспечения.  Не помечайте порт
	    как <varname>FORBIDDEN</varname>, если причина не вызвана
	    соображениями информационной безопасности.</para>
	</listitem>

	<listitem>
	  <para><varname>IGNORE</varname> предназначена для портов,
	    которые не должны строиться по какой-либо другой причине.
	    Следует использовать для портов, в случае когда проблема
	    считается структурной.  Кластер построения ни при каких
	    условиях не будет строить порты, помеченные как
	    <varname>IGNORE</varname>.  В частности, используйте
	    <varname>IGNORE</varname>, когда порт:</para>

	  <itemizedlist>
	    <listitem>
	      <para>компилируется, но работает неправильно</para>
	    </listitem>

	    <listitem>
	      <para>не работает на установленной версии &os;</para>
	    </listitem>

	    <listitem>
	      <para>имеет дистрибутивный файл, который не может быть
		автоматически извлечен из-за лицензионных
		ограничений</para>
	    </listitem>

	    <listitem>
	      <para>не работает с каким-либо другим портом,
		установленным в настоящее время (например, порт
		зависит от <package
		  role="port">www/apache20</package>, но установлен
		<package role="port">www/apache22</package>)</para>
	    </listitem>
	  </itemizedlist>

	  <note>
	    <para>Если порт будет конфликтовать с уже установленным
	      портом (например, если они устанавливают файл в то же
	      место, но с иным функциональным назначением), то <link
		linkend="conflicts">используйте вместо этого
		<varname>CONFLICTS</varname></link>.
	      <varname>CONFLICTS</varname> сам установит значение
	      <varname>IGNORE</varname>.</para>
	  </note>
	</listitem>

	<listitem>
	  <para>Если порт нужно пометить как
	    <varname>IGNORE</varname> только на некоторых
	    архитектурах, для этого есть две другие удобные
	    переменные, которые автоматически установят для вас
	    значения: <varname>ONLY_FOR_ARCHS</varname> и
	    <varname>NOT_FOR_ARCHS</varname>.  Примеры:</para>

	  <programlisting>ONLY_FOR_ARCHS=	i386 amd64</programlisting>

	  <programlisting>NOT_FOR_ARCHS=	ia64 sparc64</programlisting>

	  <para>Собственное сообщение <varname>IGNORE</varname> можно
	    задать с использованием
	    <varname>ONLY_FOR_ARCHS_REASON</varname> и
	    <varname>NOT_FOR_ARCHS_REASON</varname>.  Отдельно для
	    каждой архитектуры это возможно с использованием
	    <varname>ONLY_FOR_ARCHS_REASON_<replaceable>ARCH</replaceable></varname>
	    и
	    <varname>NOT_FOR_ARCHS_REASON_<replaceable>ARCH</replaceable></varname>.</para>
	</listitem>

	<listitem>
	  <para>Если порт загружает и устанавливает исполняемые файлы
	    i386, то следует установить
	    <varname>IA32_BINARY_PORT</varname>.  Если эта переменная
	    установлена, будет выполнена проверка доступности
	    каталога <filename>/usr/lib32</filename> для библиотек
	    версии IA32 и поддержки IA32 в ядре.  При невыполнении
	    любого из этих условий будет автоматически установлена
	    переменная <varname>IGNORE</varname>.</para>
	</listitem>
      </itemizedlist>
    </sect2>

    <sect2 xml:id="dads-noinstall-notes">
      <title>Замечания по реализации</title>

      <para>Строки не следует брать в кавычки.  Также построение
	строки должно несколько различаться из-за способа отображения
	информации пользователю.  Примеры:</para>

      <programlisting>BROKEN=	fails to link with base -lcrypto</programlisting>

      <programlisting>IGNORE=	unsupported on recent versions</programlisting>

      <para>получаемые в результате следующего вывода
	<command>make describe</command>:</para>

      <programlisting>===&gt;  foobar-0.1 is marked as broken: fails to link with base -lcrypto.</programlisting>

      <programlisting>===&gt;  foobar-0.1 is unsupported on recent versions.</programlisting>
    </sect2>
  </sect1>

  <sect1 xml:id="dads-deprecated">
    <title>Пометка порта на удаление с <varname>DEPRECATED</varname>
      или <varname>EXPIRATION_DATE</varname></title>

    <para>Помните, что <varname>BROKEN</varname> и
      <varname>FORBIDDEN</varname> будут использованы как временное
      средство, если порт не является работающим.  Постоянно
      неработоспособные порты должны полностью удаляться из
      дерева.</para>

    <para>В подходящих ситуациях пользователи могут быть оповещены о
      предстоящем удалении через переменные
      <varname>DEPRECATED</varname> и
      <varname>EXPIRATION_DATE</varname>.  Первое - это просто
      строка, сообщающая причину запланированного удаления порта;
      вторая является строкой в формате ISO 8601 (YYYY-MM-DD).  Обе
      будут показаны пользователю.</para>

    <para>Переменную <varname>DEPRECATED</varname> можно установить
      без использования <varname>EXPIRATION_DATE</varname> (в
      частности, при рекомендации новой версии порта), но обратный
      порядок не имеет никакого смысла.</para>

    <para>Не существует устоявшейся политики, как долго следует
      продолжать уведомления.  Текущая практика дает около месяца для
      решения проблем безопасности и два месяца для проблем
      построения.  Это также дает немного времени на исправление
      проблем любым заинтересованным коммиттерам.</para>
  </sect1>

  <sect1 xml:id="dads-dot-error">
    <title>Избегайте использования конструкции
      <literal>.error</literal></title>

    <para>Правильным способом подать сигнал для
      <filename>Makefile</filename> о том, что порт не может быть
      установлен из-за какого-то внешнего фактора (например,
      пользователь указал недопустимую комбинацию опций построения),
      является установка непустого значения для
      <varname>IGNORE</varname>.  Это значение будет сформатировано и
      показано пользователю во время
      <command>make install</command>.</para>

    <para>Использование для этих целей <literal>.error</literal>
      является распространенной ошибкой.  Проблема в том, что в этой
      ситуации будут повреждены многие инструменты автоматизации,
      работающие с деревом портов.  Наибольшим образом это
      распространено при попытке построить
      <filename>/usr/ports/INDEX</filename> (смотрите <xref
	linkend="make-describe"/>).  Тем не менее, даже более простые
      команды, такие как <command>make maintainer</command>, в этом
      случае также вернут ошибку.  Это не является приемлемым.</para>

    <example xml:id="dot-error-breaks-index">
      <title>Как избегать использования
	<literal>.error</literal></title>

      <para>Из следующих двух вариантов строки файла
	<filename>Makefile</filename> первый приведёт к неудачному
	завершению работы <command>make index</command>, а второй -
	нет:</para>

      <programlisting>.error "option is not supported"</programlisting>

      <programlisting>IGNORE=option is not supported</programlisting>
    </example>
  </sect1>

  <sect1 xml:id="dads-sysctl">
    <title>Использование <filename>sysctl</filename></title>

    <para>Использование <filename>sysctl</filename> не рекомендуется,
      кроме как при выполнении целей.  Это вызвано тем, что
      вычисление любых <literal>makevar</literal>, таких как во время
      команды <command>make index</command>, с необходимостью запуска
      этой команды, еще больше замедляет весь процесс.</para>

    <para>&man.sysctl.8; следует всегда использовать через переменную
      <varname>SYSCTL</varname>, поскольку она содержит полностью
      заданный путь, и при необходимости может быть
      переопределена.</para>
  </sect1>

  <sect1 xml:id="dads-rerolling-distfiles">
    <title>Меняющиеся дистрибутивные файлы</title>

    <para>Иногда авторы программного обеспечения меняют содержимое
      выпущенных дистрибутивных файлов без смены названия.  Вы должны
      проверять, что изменения являются официальными и произведены
      автором.  В прошлом бывало, что дистрибутивный файл молча
      изменялся на сайтах загрузки с намерением нанести вред или
      скомпрометировать безопасность конечного пользователя.</para>

    <para>Отложите старый файл с дистрибутивом в сторону, загрузите
      новый, распакуйте его и сравните содержимое при помощи
      &man.diff.1;.  Если вы не видите ничего подозрительного, то
      можете обновить файл <filename>distinfo</filename>.  Убедитесь,
      что вы подытожили различия в вашем PR или описании коммита,
      чтобы другие люди были в курсе, что вы позаботились о том, что
      ничего плохого не случилось.</para>

    <para>Возможно вы также захотите связаться с автором этого
      программного обеспечения для подтверждения изменений.</para>
  </sect1>

  <sect1 xml:id="dads-avoiding-linuxisms">
    <title>Избегание линуксизмов</title>

    <para>Не используйте <filename>/proc</filename>, если доступны
      любые другие источники получения информации, например,
      <function>setprogname(argv[0])</function> в
      <function>main()</function> и &man.getprogname.3;, в случае
      если вы хотите <quote>знать своё имя</quote>.</para>

    <para>Не полагайтесь на поведение, не регламентированное
      <acronym>POSIX</acronym>.</para>

    <para>Не выполняйте запись временных меток в критических путях
      выполнения приложения, если можно обойтись без этого.
      Получение временных меток может быть медленным, в зависимости
      от степени точности используемых часов в операционной системе.
      Если временные метки действительно нужны, определите степень
      требуемой точности и используйте тот <acronym>API</acronym>,
      в котором документируется получение достаточной
      точности.</para>

    <para>Ряд простых системных вызовов (например,
      &man.gettimeofday.2;, &man.getpid.2;) работают намного быстрее
      в &linux; по сравнению с любой другой операционной системой
      из-за кеширования и используемой оптимизации vsyscall.  Не
      полагайтесь на их дешевизну в критичных к производительности
      приложениях.  В целом, старайтесь избегать системных вызовов
      там, где это возможно.</para>

    <para>Не полагайтесь на специфичное для &linux; поведение сокета.
      В частности, отличаются размеры буфера сокета по умолчанию
      (выполните вызов &man.setsockopt.2; с
      <literal>SO_SNDBUF</literal> и <literal>SO_RCVBUF</literal>, и
      в то время как в &linux; при заполнении буфера сокета
      &man.send.2; блокируется, &os; возвращает ошибку и
      устанавливает <literal>ENOBUFS</literal> в качестве значения
      errno.</para>

    <para>Если требуется рассчитывать на нестандартное поведение,
      инкапсулируйте это должным образом в общий для всех
      <acronym>API</acronym> с проверкой поведения на этапе
      конфигурации, и если требуемое поведение не найдено,
      прекращайте выполнение.</para>

    <para>Используйте <link
	xlink:href="http://www.freebsd.org/cgi/man.cgi">страницы
      справочника</link> для проверки, относится ли функция к
      интерфейсу <acronym>POSIX</acronym> (ищите раздел
      <quote>STANDARDS</quote> на странице справочника).</para>

    <para>Не рассчитывайте на то, что в качестве
      <filename>/bin/sh</filename> используется
      <application>bash</application>.  Убедитесь, что командная
      строка, переданная в &man.system.3;, будет работать в
      <acronym>POSIX</acronym>-совместимой оболочке.</para>

    <para>Список основных <application>bash</application>-измов
      расположен <link
	xlink:href="https://wiki.ubuntu.com/DashAsBinSh">здесь</link>.</para>

    <para>Проверьте, что используемые заголовочные файлы включены в
      <acronym>POSIX</acronym> или список, рекомендуемый страницей
      справочника, т.к. например, забыть подключить
      <filename>sys/types.h</filename> &mdash; не такая уж проблема в
      &linux;, однако это не так во &os;.</para>

    <para>Компилируйте многопоточные приложения с ключом
      <quote>-pthread</quote>, а не <quote>-lpthread</quote> или
      как-либо ещё.</para>
  </sect1>

  <sect1 xml:id="dads-misc">
    <title>Разное</title>

    <para>Файлы <filename>pkg-descr</filename> и
      <filename>pkg-plist</filename> должны проверяться дважды.  Если
      вы пересматриваете порт и думаете, что его можно описать иначе,
      сделайте это.</para>

    <para>Пожалуйста, не создавайте дополнительных копий лицензии GNU
      General Public License в нашей системе.</para>

    <para>Будьте внимательны с юридическими вопросами!  Не делайте из
      нас нелегальных распространителей ПО!</para>
  </sect1>
</chapter>
