<?xml version="1.0" encoding="koi8-r"?>
<!--
     The FreeBSD Russian Documentation Project

     $FreeBSD$

     Original revision: r43840
-->

<chapter xmlns="http://docbook.org/ns/docbook"
  xmlns:xlink="http://www.w3.org/1999/xlink" version="5.0"
  xml:id="pkg-files">

  <title>Файлы <filename>pkg-*</filename></title>

  <para>Есть несколько приёмов работы с файлами
    <filename>pkg-*</filename>, которые мы ещё не описали, но они
    иногда могут быть очень кстати.</para>

  <sect1 xml:id="porting-message">
    <title><filename>pkg-message</filename></title>

    <para>Если вам нужно вывести сообщение для человека,
      устанавливающего приложение, то вы можете поместить сообщение в
      файл <filename>pkg-message</filename>.  Эта возможность часто
      оказывается полезной для вывода дополнительных шагов установки,
      которые нужно предпринять после выполнения команды
      <command>pkg install</command>, или для вывода информации о
      лицензировании.</para>

    <para>Если должны выводиться некоторые строки о knobs времени
      построения или предупреждения, используйте
      <varname>ECHO_MSG</varname>.  Файл
      <filename>pkg-message</filename> только для послеустановочных
      шагов.  Также следует иметь в виду различие между
      <varname>ECHO_MSG</varname> и <varname>ECHO_CMD</varname>.
      Первое предназначено для вывода на экран информационного
      текста, а второе для конвейера команд:</para>

    <programlisting>update-etc-shells:
	@${ECHO_MSG} "updating /etc/shells"
	@${CP} /etc/shells /etc/shells.bak
	@( ${GREP} -v ${PREFIX}/bin/bash /etc/shells.bak; \
		${ECHO_CMD} ${PREFIX}/bin/bash) &gt;/etc/shells
	@${RM} /etc/shells.bak</programlisting>

    <note>
      <para>Файл <filename>pkg-message</filename> не нужно добавлять в
	<filename>pkg-plist</filename>.</para>
    </note>
  </sect1>

  <sect1 xml:id="pkg-install">
    <title><filename>pkg-install</filename></title>

    <para>Если при установке бинарного пакета по команде
      <command>pkg add</command> или <command>pkg install</command>
      вашему порту нужно выполнить какие-то команды, то вы можете это
      сделать с помощью скрипта <filename>pkg-install</filename>.
      Этот скрипт будет автоматически добавлен к пакету и будет
      дважды запускаться командой <command>pkg</command>: первый раз
      в виде <literal>&dollar;{SH} pkg-install &dollar;{PKGNAME}
	PRE-INSTALL</literal>, а второй раз как
      <literal>&dollar;{SH} {PKGNAME} POST-INSTALL</literal>.  Для
      распознавания того, в каком режиме запущен скрипт, можно
      использовать параметр <literal>&dollar;2</literal>.  Переменная
      окружения <envar>PKG_PREFIX</envar> будет принимать значение,
      соответствующее каталогу, в который устанавливается
      пакет.</para>

    <note>
      <para>Этот скрипт не запускается автоматически, если вы
	устанавливаете порт командой <command>make install</command>.
	Если же вам действительно необходимо его запустить, то
	запустите его явно из файла <filename>Makefile</filename>
	порта строкой вида <literal>PKG_PREFIX=&dollar;{PREFIX}
	  &dollar;{SH} &dollar; {PKGINSTALL}&dollar;{PKGNAME}
	  PRE-INSTALL</literal>.</para>
    </note>
  </sect1>

  <sect1 xml:id="pkg-deinstall">
    <title><filename>pkg-deinstall</filename></title>

    <para>Этот скрипт вызывается при удалении пакета.</para>

    <para>Этот скрипт будет дважды запускаться командой
      <command>pkg delete</command>.  Первый раз как
      <literal>&dollar;{SH} pkg-deinstall &dollar;{PKGNAME}
	DEINSTALL</literal>, а второй раз как <literal>&dollar;{SH}
	pkg-deinstall &dollar;{PKGNAME}
	POST-DEINSTALL</literal>.</para>
  </sect1>

  <sect1 xml:id="pkg-names">
    <title xml:id="porting-pkgfiles">Изменение имён файлов
      <filename>pkg-*</filename></title>

    <para>Все имена файлов <filename>pkg-*</filename> определяются с
      помощью переменных, так что вы можете изменить их, если это
      нужно, в вашем файле <filename>Makefile</filename>.  Это
      особенно полезно, если вы используете одни и те же файлы
      <filename>pkg-*</filename> совместно между несколькими портами
      или пишете в один из вышеперечисленных файлов (в главе о <link
	linkend="porting-wrkdir">записи в каталоги, отличные от
      <varname>WRKDIR</varname></link> объяснено, почему не
      рекомендуется осуществлять запись непосредственно в файлы
      <filename>pkg-*</filename>.</para>

    <para>Вот список имён переменных и их значений по умолчанию.
      (Значение <varname>PKGDIR</varname> по умолчанию равно
      <varname>${MASTERDIR}</varname>.)</para>

    <informaltable frame="none" pgwide="0">
      <tgroup cols="2">
	<thead>
	  <row>
	    <entry>Переменная</entry>
	    <entry>Значение по умолчанию</entry>
	  </row>
	</thead>

	<tbody>
	  <row>
	    <entry><varname>DESCR</varname></entry>
	    <entry><literal>${PKGDIR}/pkg-descr</literal></entry>
	  </row>

	  <row>
	    <entry><varname>PLIST</varname></entry>
	    <entry><literal>${PKGDIR}/pkg-plist</literal></entry>
	  </row>

	  <row>
	    <entry><varname>PKGINSTALL</varname></entry>
	    <entry><literal>${PKGDIR}/pkg-install</literal></entry>
	  </row>

	  <row>
	    <entry><varname>PKGDEINSTALL</varname></entry>
	    <entry><literal>${PKGDIR}/pkg-deinstall</literal></entry>
	  </row>

	  <row>
	    <entry><varname>PKGMESSAGE</varname></entry>
	    <entry><literal>${PKGDIR}/pkg-message</literal></entry>
	  </row>
	</tbody>
      </tgroup>
    </informaltable>

    <para>Пожалуйста, изменяйте значения этих переменных, а не
      переопределяйте <varname>PKG_ARGS</varname>.  Если вы измените
      значение переменных <varname>PKG_ARGS</varname>, то эти файлы
      при установке из порта будут установлены в каталог
      <filename>/var/db/pkg</filename> некорректно.</para>
  </sect1>

  <sect1 xml:id="using-sub-files">
    <title>Использование <varname>SUB_FILES</varname> и
      <varname>SUB_LIST</varname></title>

    <para>Переменные <varname>SUB_FILES</varname> и
      <varname>SUB_LIST</varname> подходят для задания в файлах порта
      динамических значений, таких как <varname>PREFIX</varname>
      установки в <filename>pkg-message</filename>.</para>

    <para>В переменной <varname>SUB_FILES</varname> указывается
      перечень файлов для автоматического изменения.  Каждый
      <replaceable>file</replaceable> из перечня
      <varname>SUB_FILES</varname> обязан иметь соответствующий
      <filename>file.in</filename>, присутствующий в
      <varname>FILESDIR</varname>.  Измененная версия будет создана в
      <varname>WRKDIR</varname>.  Файлы, определенные в качестве
      значения <varname>USE_RC_SUBR</varname> (или устаревшего
      <varname>USE_RCORDER</varname>), автоматически добавляются в
      <varname>SUB_FILES</varname>.  Для файлов
      <filename>pkg-message</filename>,
      <filename>pkg-install</filename> и
      <filename>pkg-deinstall</filename> устанавливается
      соответствующая переменная Makefile, указывающая на
      обработанную версию.</para>

    <para>Переменная <varname>SUB_LIST</varname> содержит перечень
      пар <literal>VAR=VALUE</literal>.  В каждом файле из
      <varname>SUB_FILES</varname> для каждой пары будет произведена
      замена <literal>%%VAR%%</literal> на <literal>VALUE</literal>.
      Некоторые общие пары определяются автоматически:
      <varname>PREFIX</varname>, <varname>LOCALBASE</varname>,
      <varname>DATADIR</varname>, <varname>DOCSDIR</varname>,
      <varname>EXAMPLESDIR</varname>, <varname>WWWDIR</varname> и
      <varname>ETCDIR</varname>.  Любая строка, начинающаяся с
      <literal>@comment</literal>, будет удалена из конечного файла
      после подстановки переменной.</para>

    <para>В следующем примере в <filename>pkg-message</filename>
      будет сделана замена <literal>%%ARCH%%</literal> на системную
      архитектуру:</para>

    <programlisting>SUB_FILES=	pkg-message
SUB_LIST=	ARCH=${ARCH}</programlisting>

    <para>Обратите внимание, что в этом примере в
      <varname>FILESDIR</varname> обязательно существование файла
      <filename>pkg-message.in</filename>.</para>

    <para>Пример хорошего <filename>pkg-message.in</filename>:</para>

    <programlisting>Now it is time to configure this package.
Copy %%PREFIX%%/share/examples/putsy/%%ARCH%%.conf into your home directory
as .putsy.conf and edit it.</programlisting>
  </sect1>
</chapter>
